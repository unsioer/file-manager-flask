<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.0, minimum-scale=1.0">
	<title>Hence File Manager</title>
	<link id="favicon" rel="shortcut icon" type="image/x-icon" href="/static/icon/favicon.ico" />
	<link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.2/css/all.css" rel="stylesheet">
	<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<style>
		/*.fas {
			margin-right: 7px;
    		margin-left: 7px;
    		line-height: 22px;
    		vertical-align: baseline;
			vertical-align: middle;
			display: table-cell;
		}
		.file-item {
			text-align: center;
			display: table;
		}*/
	</style>
</head>

<body>
	<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
		<div class="container">
			<a href="" class="nav navbar-brand"><b>Hence File Manager</b></a>
		</div>
	</nav>

	<div class="jumbotron jumbotron-fluid">
		<div class="container">
			<form method="post">
				<input type="file" id="file">
				<button class="btn btn-primary" id="file-submit" type="button">保存</button>
				<div class="alert" role="alert" id="result"></div>
			</form>
			
			<button class="btn" id="refresh" onclick="refresh()"><i class="fas fa-sync" aria-hidden="true"></i></button>
			<div class="toolbar">
			</div>
			<nav>
				<ol class="breadcrumb">
					<li class="breadcrumb-item active" aria-current="page">
						<a href="/app" title="根目录">
							<i class="fas fa-folder"></i>
						</a>
					</li>
				</ol>
			</nav>
			<table class="col-12">
				<!--tr>
					<th colspan="3">
						<ol class="breadcrumb">
							<li class="breadcrumb-item active" aria-current="page">
								<a href="/app" title="根目录">
									<i class="fas fa-folder"></i>
								</a>
							</li>
						</ol>
					</th>
				</tr-->
				<!--tr>
					<th>Name</th>
					<th>Size</th>
					<th>Modified</th>
				</tr-->
				<tr>
					<td class="file-item">
						<i class="fas fa-folder" aria-hidden="true"></i>
						<a id='father'>..</a>
					</td>
				</tr>
				{% for file in files %}
				<tr>
					<td class="file-item">
						{% if file.type == 0 %}
						<i class="fas fa-folder" aria-hidden="true"></i>

						{% else %}
						<i class="fas fa-file" aria-hidden="true"></i>
						{% endif %}
						<a {% if file.type==0 %}href="/app/{{file.path}}" {% endif %}>{{file.name}}</a>
					</td>
					<td class="file-size">
						{% if file.type != 0 %}

						{{ file.size }}

						{% endif %}
					</td>
					<td>{{file.mtime}}</td>
				</tr>
				{% endfor %}
			</table>
		</div>
	</div>
	<footer class="footer">
		<div class="container text-center">
			<div class="col-12">
				<b>Hence File Manager</b> © 2021 <a href="https://enatsu.top">Enatsu</a>
			</div>
		</div>
	</footer>
	<script type="text/javascript">
		function processFather() {
			$("#father").attr("href", window.location.href.replace(/(.+)\/.+/g, '$1', 1));

		}
		function fixFileSize() {
			for (i = 0; i < $('.file-size').length; i++) {
				size = $($('.file-size')[i]).text().trim()
				if (size === '') continue;
				if (size > 1024) {
					if (size > 1024 * 1024) {
						if (size > 1024 * 1024 * 1024) {
							$($('.file-size')[i]).text(Number(size / (1024 * 1024 * 1024)).toFixed(2) + 'G');
						} else $($('.file-size')[i]).text(Number(size / (1024 * 1024)).toFixed(2) + 'M');
					}
					else $($('.file-size')[i]).text(Number(size / (1024)).toFixed(2) + 'K');
				} else $($('.file-size')[i]).text(size + 'B');
			}
		}
		function refresh(){
			$.ajax({
					url: window.location.href.replace('/app', '/api', 1),
					type: 'get',
					cache: false,
					processData: false,
					contentType: false,
					success: function (data) {
						console.log(data);
						$("#result").text(JSON.stringify(data)).addClass("alert-success").removeClass("alert-danger");
					},
					error: function (err) {
						alert('获取最新目录失败，请稍后重试。',err);
					}
				});
		}

		$(document).ready(function () {
			processFather();
			fixFileSize();
		});


		$('#file-submit').click(function () {
			if ($('#file').prop('files')[0] == null) {
				alert('上传文件为空！');
			}
			else {
				var files = $('#file').prop('files');
				var data = new FormData();
				data.append('file', files[0]);
				$.ajax({
					url: window.location.href.replace('/app', '/api', 1),
					type: 'POST',
					data: data,
					cache: false,
					processData: false,
					contentType: false,
					success: function (data) {
						console.log(data);
						$("#result").text(JSON.stringify(data)).addClass("alert-success").removeClass("alert-danger");
					},
					error: function (err) {
						console.error(err);
						$("#result").html(err.responseText).removeClass("alert-success").addClass("alert-danger");
					}
				});
			}
		});

	</script>
</body>
</html>